<script>
    /* --- [JS] å…±é€šãƒ‡ãƒ¼ã‚¿ç®¡ç† --- */
    let logs = JSON.parse(localStorage.getItem('arirang_logs') || '[]');
    let speed = localStorage.getItem('arirang_speed') || 5000;
    let user = localStorage.getItem('arirang_user') || 'Army';

    function init() {
        const now = new Date();
        document.getElementById('dateIn').value = now.toISOString().split('T')[0];
        document.getElementById('timeIn').value = now.toTimeString().slice(0,5);
        document.getElementById('speedSet').value = speed;
        document.getElementById('userName').value = user;
        updateLevel();
        // åˆæœŸçŠ¶æ…‹ã§ã‚‚è¨ˆç®—ã‚’èµ°ã‚‰ã›ã‚‹
        calcPreview();
    }

    /* --- [JS] è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ) --- */
    function calcPreview() {
        const count = document.getElementById('countIn').value;
        const startTimeStr = document.getElementById('timeIn').value;
        const startDateStr = document.getElementById('dateIn').value;

        if(!count || !startTimeStr) return;

        // 1åˆ†ã‚ãŸã‚Šã®é€²ã‚€äººæ•°
        const peoplePerMin = speed / 60;
        const mins = Math.ceil(count / peoplePerMin);

        // ã€Œã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ã€ã‚’ãƒ™ãƒ¼ã‚¹ã«æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const startDateTime = new Date(`${startDateStr}T${startTimeStr}`);
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ã«å¾…ã¡æ™‚é–“ã‚’åŠ ç®—
        const etaDate = new Date(startDateTime.getTime() + mins * 60000);
        const etaStr = etaDate.toTimeString().slice(0,5);
        
        document.getElementById('preMin').innerText = mins;
        document.getElementById('preEta').innerText = etaStr;
        
        return { mins, eta: etaStr };
    }

    /* --- [JS] ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
    function show(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'histView') renderLogs();
    }

    /* --- [JS] ä¿å­˜ãƒ»å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯ --- */
    function saveLog(isSuccess) {
        const count = document.getElementById('countIn').value;
        if(!count) return alert("äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");

        const pre = calcPreview(); // ä¿®æ­£ã•ã‚ŒãŸã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ãƒ™ãƒ¼ã‚¹ã®äºˆæ¸¬ã‚’å–å¾—
        const memo = prompt("ãƒ¡ãƒ¢ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰");

        const newLog = {
            id: Date.now(),
            user: user,
            date: document.getElementById('dateIn').value,
            count: count,
            start: document.getElementById('timeIn').value,
            eta: pre.eta,
            success: isSuccess,
            memo: memo || ""
        };

        logs.push(newLog);
        localStorage.setItem('arirang_logs', JSON.stringify(logs));
        alert("Magic Recorded! âœ¨");
        location.reload();
    }

    function deleteLog(id) {
        if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        logs = logs.filter(l => l.id !== id);
        localStorage.setItem('arirang_logs', JSON.stringify(logs));
        renderLogs();
        updateLevel();
    }

    function saveSpeed() {
        speed = document.getElementById('speedSet').value;
        localStorage.setItem('arirang_speed', speed);
        alert("Speed updated!");
        show('mainView');
        calcPreview(); // ä¿å­˜å¾Œã«å†è¨ˆç®—
    }

    function saveUserName() {
        user = document.getElementById('userName').value;
        localStorage.setItem('arirang_user', user);
    }

    function renderLogs() {
        const list = document.getElementById('logList');
        list.innerHTML = logs.slice().reverse().map(l => `
            <div class="history-card">
                <b>${l.date} | ${l.user}</b><br>
                äººæ•°: ${l.count}äºº | é–‹å§‹: ${l.start} | å…¥å®¤ç›®å®‰: ${l.eta}<br>
                çµæœ: ${l.success ? '<span style="color:green">SUCCESS âœ…</span>' : '<span style="color:red">FAILED âŒ</span>'}<br>
                ${l.memo ? `<span style="color:#666;">ğŸ“ ${l.memo}</span><br>` : ''}
                <button class="del-btn" onclick="deleteLog(${l.id})">å‰Šé™¤</button>
            </div>
        `).join('');
    }

    function updateLevel() {
        const lv = Math.floor(logs.length / 3) + 1;
        document.getElementById('lvlDisplay').innerText = `LV.${lv}`;
    }

    // å…¥åŠ›å€¤ãŒå¤‰ã‚ã‚‹ãŸã³ã«è¨ˆç®—ã‚’èµ°ã‚‰ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('timeIn').addEventListener('input', calcPreview);
    document.getElementById('dateIn').addEventListener('input', calcPreview);

    init();
</script>
